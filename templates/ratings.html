<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Ratings Page</title>

        <link href="{{ url_for('static', filename='styles/ratings.css') }}" rel="stylesheet">
    </head>

    <body>
        <h1>Ratings Page</h1>

        <div class="filters">
            <div class="filter-controls">
                <input type="text" id="searchInput" placeholder="Search by name, surname or username..." oninput="filterUsers()">
                
                <select id="facultyFilter" onchange="filterUsers()">
                    <option value="">All Faculties</option>
                </select>
                
                <select id="roleFilter" onchange="filterUsers()">
                    <option value="">All Roles</option>
                </select>
                
                <select id="sortFilter" onchange="filterUsers()">
                    <option value="rating_desc">Rating (High to Low)</option>
                    <option value="rating_asc">Rating (Low to High)</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                </select>
                
                <button type="button" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
        
        <div id="usersContainer">
            {% if ratings %}
                {% for rating in ratings %}
                    <div class="user"
                         data-username="{{ rating['username'] }}"
                         data-name="{{ rating['name'] }}"
                         data-surname="{{ rating['surname'] }}"
                         data-faculty="{{ rating['faculty'] }}"
                         data-role="{{ rating['role'] }}"
                         data-rating="{{ rating['rating'] }}">
                         
                        <img src="{{ url_for('static', filename=rating['avatar']) }}">

                        <p class="username">{{ rating["username"] }}</p>
                        <p class="name">{{ rating["name"] }}</p>
                        <p class="surname">{{ rating["surname"] }}</p>
                        <p class="gradeNfaculty">{{ rating["grade"] }} {{ rating["faculty"] }}</p>
                        <p class="rating">{{ rating["rating"] }}</p>
                        <p class="role">{{ rating["role"] }}</p>

                        <form method="POST">
                            <input name="username" type="hidden" value="{{ rating['username'] }}">
                            <button type="submit">View User</button>
                        </form>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flashed_messages">
                    {% for message in messages %}
                        <p class="flashed_message">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <script>
            let allUsers = [];
            
            document.addEventListener('DOMContentLoaded', function() {
                const userElements = document.querySelectorAll('.user');
                allUsers = Array.from(userElements);
                populateFilterOptions();
            });
            
            function populateFilterOptions() {
                const faculties = new Set();
                const roles = new Set();
                
                allUsers.forEach(user => {
                    const faculty = user.dataset.faculty;
                    const role = user.dataset.role;
                    if (faculty) faculties.add(faculty);
                    if (role) roles.add(role);
                });
                
                const facultySelect = document.getElementById('facultyFilter');
                Array.from(faculties).sort().forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty;
                    option.textContent = faculty;
                    facultySelect.appendChild(option);
                });
                
                const roleSelect = document.getElementById('roleFilter');
                Array.from(roles).sort().forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    roleSelect.appendChild(option);
                });
            }
            
            function filterUsers() {
                const searchText = document.getElementById('searchInput').value.toLowerCase();
                const faculty = document.getElementById('facultyFilter').value;
                const role = document.getElementById('roleFilter').value;
                const sortBy = document.getElementById('sortFilter').value;
                
                let visibleUsers = [];
                
                allUsers.forEach(user => {
                    let showUser = true;
                    
                    if (searchText) {
                        const username = user.dataset.username.toLowerCase();
                        const name = user.dataset.name.toLowerCase();
                        const surname = user.dataset.surname.toLowerCase();
                        if (!username.includes(searchText) &&
                            !name.includes(searchText) &&
                            !surname.includes(searchText)) {
                            showUser = false;
                        }
                    }
                    
                    if (faculty && user.dataset.faculty !== faculty) showUser = false;
                    if (role && user.dataset.role !== role) showUser = false;
                    
                    if (showUser) {
                        user.classList.remove('hidden');
                        visibleUsers.push(user);
                    } else {
                        user.classList.add('hidden');
                    }
                });
                
                sortUsers(visibleUsers, sortBy);
                showNoResultsMessage(visibleUsers.length === 0);
            }
            
            function sortUsers(users, sortBy) {
                const container = document.getElementById('usersContainer');
                users.sort((a, b) => {
                    switch (sortBy) {
                        case 'rating_desc':
                            return parseFloat(b.dataset.rating) - parseFloat(a.dataset.rating);
                        case 'rating_asc':
                            return parseFloat(a.dataset.rating) - parseFloat(b.dataset.rating);
                        case 'name_asc':
                            return (a.dataset.name + a.dataset.surname).localeCompare(b.dataset.name + b.dataset.surname);
                        case 'name_desc':
                            return (b.dataset.name + b.dataset.surname).localeCompare(a.dataset.name + a.dataset.surname);
                        default:
                            return 0;
                    }
                });
                users.forEach(user => container.appendChild(user));
            }
            
            function showNoResultsMessage(show) {
                let message = document.querySelector('.no-results');
                if (show && !message) {
                    message = document.createElement('div');
                    message.className = 'no-results';
                    message.textContent = 'No users found matching your criteria.';
                    document.getElementById('usersContainer').appendChild(message);
                } else if (!show && message) {
                    message.remove();
                }
            }
            
            function clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('facultyFilter').value = '';
                document.getElementById('roleFilter').value = '';
                document.getElementById('sortFilter').value = 'rating_desc';
                filterUsers();
            }
        </script>
    </body>
</html>
